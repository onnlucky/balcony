<!DOCTYPE html>
<meta charset="utf-8">
<title>balcony</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<style>

body { font: 14px sans-serif; }

svg { font: 10px sans-serif; }

.axis path,
.axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
}

.x.axis path {
    display: none;
}

.line {
    fill: none;
    stroke: black;
    stroke-width: 1.5px;
}

.temperature { stroke: #10509a; }
.humidity { stroke: #b4cfee; }

</style>
<body>
<p id=status>unknown</p>
<script>

var margin = { top: 10, right: 50, bottom: 30, left: 50 }
var width = document.body.offsetWidth - margin.left - margin.right
var height = 400 - margin.top - margin.bottom

var _data = []
var bisectDate = d3.bisector(function(d) { return d[0] }).left;

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom)
    .append("g").attr("transform", "translate(" + margin.left +","+ margin.top +")")

// time
var x = d3.time.scale().range([0, width]).domain([-1 + new Date, +new Date])
var xAxis = d3.svg.axis().scale(x).orient("bottom")
var xG = svg.append("g")
    .attr("class", "x axis").attr("transform", "translate(0,"+ height +")")
    .call(xAxis)

function plot(name, at, label, n, total, options) {
  options = options || {}
  var orient = options.orient || "left"

  var scale = d3.scale.linear().range([height / total * n - 5, height / total * (n - 1) + 5])
  if (options.domain) scale.domain(options.domain)

  var axis = d3.svg.axis().scale(scale).orient(orient)
  var line = d3.svg.line()
    .x(function(d) { return x(d[0])})
    .y(function(d) { return scale(d[at])})

  var tx = orient == "left"? 0 : width
  var dy = orient == "left"? "1.5em" : "4em"
  var g = svg.append("g")
    .attr("class", "axis "+ name)
    .attr("transform", "translate("+ tx +", 0)")
    .call(axis)
  g.append("text").text(label)
      .attr("transform", "rotate(-90)").attr("x", -scale.range()[1]).attr("dy", dy).style("text-anchor", "end")

  var path = svg.append("path")
    .attr("class", "line "+ name)
    .datum([])
    .attr("d", line)

  var datum = function(data) {
    if (!options.domain) {
      scale.domain(d3.extent(data, function(d) { return d[at] })).nice()
      axis.scale(scale)
    }
    g.call(axis)
    path.datum(data).attr("d", line)
  }

  return { scale: scale, datum: datum }
}

var battery = plot("battery", 1, "Battery (V)", 1, 3, {domain: [10, 15], orient: "right"})
var temperature = plot("temperature", 4, "Temperature (c)", 2, 3, {orient: "right"})
var humidity = plot("humidity", 5, "Humidity (%)", 2, 3, {domain: [0, 100]})

var mainbucket = plot("mainbucket", 2, "Main Bucket Level", 3, 3, {domain: [0, 100], orient: "right"})
var highbucket = plot("highbucket", 3, "High Bucket Level", 3, 3, {domain: [512, 1024]})

// focus
var focus = svg.append("g").style("display", "none").attr("transform", "translate("+ width +",0)")
focus.append("circle").attr("cy", height).attr("r", 3).style("fill", "black")
focus.append("line").attr("stroke", "blue").style("stroke-dasharray", "3,3").style("opacity", 0.5)
  .attr("y1", 0).attr("y2", height)

var batteryLabel = focus.append("text")
var temperatureLabel = focus.append("text")
var humidityLabel = focus.append("text")
var mainbucketLabel = focus.append("text")
var highbucketLabel = focus.append("text")

svg.append("rect")
  .attr("width", width).attr("height", height).style("fill", "none").style("pointer-events", "all")
  .on("mouseover", function() { focus.style("display", null)})
  .on("mouseout", function() { focus.style("display", "none")})
  .on("mousemove", function() {
    if (_data.length == 0) return
    var x0 = x.invert(d3.mouse(this)[0])
    var at = bisectDate(_data, x0, 1)
    var d = _data[at]
    focus.attr("transform", "translate("+ x(d[0]) +",0)")

    var by = battery.scale(d[1])
    var ty = temperature.scale(d[4])
    var hy = humidity.scale(d[5])
    var mby = mainbucket.scale(d[2])
    var hby = highbucket.scale(d[3])
    // TODO spread them out if close together
    batteryLabel.attr("y", by).text(d[1].toFixed(1))
    temperatureLabel.attr("y", ty).text(d[4].toFixed(1))
    humidityLabel.attr("y", hy).text(d[5].toFixed(1))
    mainbucketLabel.attr("y", mby).text(d[2].toFixed(0))
    highbucketLabel.attr("y", hby).text(d[3].toFixed(0))
  })


function update() {
    var query = "SELECT MEAN(battery_level),MEAN(mainbucket_level),MEAN(highbucket_level),MEAN(celcius),MEAN(humidity) FROM balcony WHERE time > now() - 1d GROUP BY time(1m) fill(previous)"
    d3.json("http://localhost:8086/query?db=balcony&q="+ encodeURIComponent(query), function(error, data) {
        if (error) return console.error(error)

        _data = data.results[0].series[0].values
        _data.forEach(function(v) { v[0] = +new Date(v[0]) })

        x.domain(d3.extent(_data, function(d) { return d[0] }))
        xG.call(xAxis)

        battery.datum(_data)
        temperature.datum(_data)
        humidity.datum(_data)
        mainbucket.datum(_data)
        highbucket.datum(_data)
    })

    d3.json("/status", function(error, data) {
      try {
        if (error) {
          d3.select("#status").text("server error")
        } else if (data) {
          d3.select("#status").text("uptime: "+ data.uptime +", balcony r"+ data.r + ", battery: "+ data.battery.level.toFixed(1) +" V")
        } else {
          d3.select("#status").text("disconnected")
        }
      } catch (e) {
        d3.select("#status").text("server communication error")
        console.error(e)
      }
    })
}

setInterval(update, 5000); update()
</script>
